<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>StockVibe - Professional Analytics Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      max-width: 1000px;
      margin: auto;
      background-color: #f8f9fa;
    }

    h2 { color: #2c3e50; }

    input, button {
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    button {
      background-color: #005fb8;
      color: white;
      cursor: pointer;
      border: none;
      transition: background 0.2s;
    }

    button:hover { background-color: #004a8f; }

    #search-container {
      position: relative;
      margin-bottom: 30px;
      z-index: 100;
    }

    #suggestions {
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      width: 340px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border-radius: 0 0 4px 4px;
    }

    .suggestion {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .suggestion:hover { background: #f0f7ff; }

    .card {
      background: white;
      border: 1px solid #e0e0e0;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    #stats, #riskStats {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .stat {
      background: #fafafa;
      padding: 12px;
      border: 1px solid #f0f0f0;
      border-radius: 6px;
      min-width: 150px;
      text-align: left;
      position: relative;
      cursor: help;
    }

    .stat .tooltiptext {
      visibility: hidden;
      width: 220px;
      background-color: #333;
      color: #fff;
      text-align: left;
      border-radius: 6px;
      padding: 10px;
      position: absolute;
      z-index: 10;
      bottom: 110%;
      left: 50%;
      margin-left: -110px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 11px;
      line-height: 1.4;
      pointer-events: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .stat:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    #newsSentimentCard {
      border-left: 5px solid #005fb8;
    }
  </style>
</head>

<body>
  <h2>Realtime Stock Analytics</h2>

  <div id="search-container">
    <input id="searchBox" placeholder="Search company or symbol (e.g. Apple, AAPL)" style="width:340px" />
    <button onclick="doSearch()">Search</button>
    <div id="suggestions"></div>
  </div>

  <div class="card" id="mainDashboard">
    <strong id="selectedTitle" style="font-size: 20px;">No symbol selected</strong>
    
    <div id="stats"></div>

    <div id="riskAnalyticsCard" style="display:none; margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc;">
      <strong style="font-size: 14px; color: #555; display: block; margin-bottom: 10px;">Risk & Performance Metrics</strong>
      <div id="riskStats"></div>
    </div>

    <div style="margin-top: 25px;">
      <canvas id="chart" width="900" height="300"></canvas>
    </div>
  </div>

  <div class="card" id="newsSentimentCard" style="display:none">
    <strong>Market Sentiment Analysis</strong>
    <div id="newsSentimentResult" style="margin-top:10px; font-size:15px; line-height: 1.6;"></div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:8000";
    let ws;
    let currentSymbol = null;
    let chart;

    const metricExplanations = {
      "Last price": "The most recent execution price recorded for this asset.",
      "5-day MA": "Average closing price over the last 5 days. Used to identify short-term momentum.",
      "20-day MA": "Average closing price over the last 20 days. Used to identify medium-term trends.",
      "Sharpe Ratio": "Measures risk-adjusted return. A ratio > 1.0 is generally considered good by investors.",
      "95% VaR": "Value at Risk: The maximum expected loss over a day at a 95% confidence level.",
      "Ann. Volatility": "The standard deviation of returns, annualized. Indicates price stability.",
      "% Change": "Percentage difference between the start and end of the 90-day period."
    };

    async function doSearch() {
      const q = document.getElementById("searchBox").value.trim();
      if (!q) return alert("Type a company name or symbol to search.");
      const res = await fetch(`${API_BASE}/search?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      showSuggestions(data.results || []);
    }

    function showSuggestions(list) {
      const box = document.getElementById("suggestions");
      box.innerHTML = "";
      if (!list || list.length === 0) {
        box.style.display = "none";
        return;
      }
      list.forEach(item => {
        const el = document.createElement("div");
        el.className = "suggestion";
        el.innerText = `${item.symbol} — ${item.description || ""} (${item.type || item.currency || ""})`;
        el.onclick = () => {
          box.style.display = "none";
          selectSymbol(item.symbol, item.description);
        };
        box.appendChild(el);
      });
      box.style.display = "block";
    }

    async function selectSymbol(symbol, desc) {
      currentSymbol = symbol;
      document.getElementById("selectedTitle").innerText = `${symbol} — ${desc || ""}`;
      
      const a = await fetch(`${API_BASE}/analytics/${encodeURIComponent(symbol)}?period_days=90`);
      const j = await a.json();
      if (j.error) {
        alert("Analytics error: " + j.error);
        return;
      }
      
      renderStats(j);
      renderChart(j.history.labels, j.history.prices, symbol);
      openWebSocketAndSubscribe(symbol);
      fetchNewsSentiment(symbol);
    }

    function renderStats(obj) {
      const div = document.getElementById("stats");
      const riskCard = document.getElementById("riskAnalyticsCard");
      const riskDiv = document.getElementById("riskStats");

      div.innerHTML = "";
      riskDiv.innerHTML = "";

      const make = (k, v, color = "#000") => {
        const tip = metricExplanations[k] || "";
        return `
        <div class="stat">
            <div style="font-size:12px;color:#666">${k}</div>
            <div style="font-size:18px;color:${color}">${v}</div>
            <span class="tooltiptext">${tip}</span>
        </div>`;
      };

      div.innerHTML += make("Last price", obj.last_price ?? "—");
      div.innerHTML += make("5-day MA", obj.ma_short ?? "—");
      div.innerHTML += make("20-day MA", obj.ma_long ?? "—");

      if (obj.sharpe_ratio !== undefined || obj.volatility_annualized !== undefined) {
        riskCard.style.display = "block";
        const vol = obj.volatility_annualized ? (obj.volatility_annualized * 100).toFixed(2) + "%" : "—";
        riskDiv.innerHTML += make("Ann. Volatility", vol);
        riskDiv.innerHTML += make("Sharpe Ratio", obj.sharpe_ratio ?? "—", obj.sharpe_ratio > 1 ? "#090" : "#444");
        const varValue = obj.value_at_risk_95 ? (obj.value_at_risk_95 * 100).toFixed(2) + "%" : "—";
        riskDiv.innerHTML += make("95% VaR", varValue, "#b00");
        const changeColor = obj.percent_change_period >= 0 ? "#090" : "#b00";
        riskDiv.innerHTML += make("% Change", (obj.percent_change_period ?? "—") + "%", changeColor);
      } else {
        riskCard.style.display = "none";
      }
    }

    async function fetchNewsSentiment(symbol) {
      const card = document.getElementById("newsSentimentCard");
      const resultDiv = document.getElementById("newsSentimentResult");
      card.style.display = "block";
      resultDiv.innerHTML = "<em>Analyzing market sentiment using FinBERT...</em>";
      try {
        const res = await fetch(`${API_BASE}/news-sentiment/${encodeURIComponent(symbol)}`);
        const data = await res.json();
        if (data.error) {
          resultDiv.innerHTML = `<span style='color:#b00'>Error: ${data.error}</span>`;
          return;
        }
        let color = data.summary === "positive" ? "#090" : data.summary === "negative" ? "#b00" : "#888";
        resultDiv.innerHTML = `
          <b>Sentiment:</b> <span style='color:${color};text-transform:capitalize'>${data.summary}</span> 
          (${(data.confidence * 100).toFixed(1)}% confidence)<br/>
          <div style="font-size:12px; color:#666; margin-top:5px;">
            Pos: ${(data.sentiment_scores.positive * 100).toFixed(1)}% | 
            Neg: ${(data.sentiment_scores.negative * 100).toFixed(1)}% | 
            Neu: ${(data.sentiment_scores.neutral * 100).toFixed(1)}%
          </div>
        `;
      } catch (e) {
        resultDiv.innerHTML = `<span style='color:#b00'>Error fetching sentiment analysis.</span>`;
      }
    }

    function renderChart(labels, prices, symbol) {
      const ctx = document.getElementById("chart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{ label: symbol, data: prices, fill: false, tension: 0.1, borderColor: '#005fb8' }]
        },
        options: { animation: false, responsive: true }
      });
    }

    function openWebSocketAndSubscribe(symbol) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ action: "subscribe", symbol }));
        return;
      }
      ws = new WebSocket("ws://127.0.0.1:8000/ws");
      ws.onopen = () => ws.send(JSON.stringify({ action: "subscribe", symbol }));
      ws.onmessage = (evt) => {
        try {
          const msg = JSON.parse(evt.data);
          if (msg.type === "price" && msg.symbol === currentSymbol) {
            const price = msg.price;
            const ts = new Date(msg.ts * 1000).toLocaleTimeString();
            if (chart) {
              chart.data.labels.push(ts);
              chart.data.datasets[0].data.push(price);
              if (chart.data.labels.length > 120) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
              }
              chart.update();
            }
            const firstStat = document.getElementById("stats").children[0];
            if (firstStat) {
              firstStat.innerHTML = `<div style="font-size:12px;color:#666">Last price</div><div style="font-size:18px">${price}</div><span class="tooltiptext">${metricExplanations["Last price"]}</span>`;
            }
          }
        } catch (e) { console.error(e); }
      };
    }

    document.getElementById("searchBox").addEventListener("keydown", (e) => {
      if (e.key === "Enter") doSearch();
    });
  </script>
</body>

</html>